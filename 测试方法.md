# CentOS服务器测试方法

## 一、配置环境变量

### 1. 创建 .env 文件

```bash
cd /root/stmp  # 进入项目目录（根据你的实际路径调整）
cat > .env << 'EOF'
QQ_EMAIL=your_email@qq.com
QQ_AUTH_CODE=your_auth_code_here
SERVER_PORT=12889
EOF
```

### 2. 编辑 .env 文件，填入真实的QQ邮箱和授权码

```bash
vi .env
# 或者使用 nano
nano .env
```

**配置内容示例：**
```
QQ_EMAIL=123456789@qq.com
QQ_AUTH_CODE=abcdefghijklmnop
SERVER_PORT=12889
```

## 二、启动服务

### 方式1：前台运行（测试用）

```bash
npm start
```

### 方式2：后台运行（推荐）

```bash
# 使用 nohup 后台运行
nohup npm start > email-service.log 2>&1 &

# 查看进程
ps aux | grep node

# 查看日志
tail -f email-service.log
```

### 方式3：使用 PM2（生产环境推荐）

```bash
# 安装 PM2
npm install -g pm2

# 启动服务
pm2 start server.js --name email-service

# 查看状态
pm2 status

# 查看日志
pm2 logs email-service

# 停止服务
pm2 stop email-service

# 重启服务
pm2 restart email-service
```

## 三、测试服务

### 1. 测试服务是否启动（健康检查）

```bash
# 测试根路径
curl http://localhost:12889/

# 测试健康检查接口
curl http://localhost:12889/api/health
```

**预期响应：**
```json
{
  "success": true,
  "message": "邮件服务运行正常",
  "timestamp": "2025-11-11T12:00:00.000Z"
}
```

### 2. 测试发送邮件接口（纯文本）

```bash
curl -X POST http://localhost:12889/api/send-email \
  -H "Content-Type: application/json" \
  -d '{
    "to": "recipient@example.com",
    "subject": "测试邮件 - 来自CentOS服务器",
    "text": "这是一封测试邮件，用于验证QQ邮箱SMTP服务是否正常工作。"
  }'
```

**预期成功响应：**
```json
{
  "success": true,
  "message": "邮件发送成功",
  "messageId": "<message-id>"
}
```

### 3. 测试发送邮件接口（HTML格式）

```bash
curl -X POST http://localhost:12889/api/send-email \
  -H "Content-Type: application/json" \
  -d '{
    "to": "recipient@example.com",
    "subject": "测试邮件 - HTML格式",
    "html": "<h1>测试邮件</h1><p>这是一封<strong>HTML格式</strong>的测试邮件。</p>"
  }'
```

### 4. 测试发送邮件接口（同时包含text和html）

```bash
curl -X POST http://localhost:12889/api/send-email \
  -H "Content-Type: application/json" \
  -d '{
    "to": "recipient@example.com",
    "subject": "任务完成通知",
    "text": "您的任务已完成",
    "html": "<h2>任务完成通知</h2><p>您的任务已成功完成！</p>"
  }'
```

### 5. 测试错误情况（缺少必填参数）

```bash
# 缺少收件人
curl -X POST http://localhost:12889/api/send-email \
  -H "Content-Type: application/json" \
  -d '{
    "subject": "测试",
    "text": "测试内容"
  }'

# 预期响应：
# {
#   "success": false,
#   "message": "缺少必填参数：to（收件人邮箱地址）"
# }
```

## 四、完整测试脚本

创建一个测试脚本文件：

```bash
cat > test_email.sh << 'EOF'
#!/bin/bash

# 测试配置
API_URL="http://localhost:12889"
TO_EMAIL="your_test_email@example.com"  # 修改为你的测试邮箱

echo "=========================================="
echo "开始测试QQ邮箱自动发送邮件服务"
echo "=========================================="
echo ""

# 1. 测试健康检查
echo "1. 测试健康检查接口..."
curl -s $API_URL/api/health | python3 -m json.tool
echo ""
echo ""

# 2. 测试发送纯文本邮件
echo "2. 测试发送纯文本邮件..."
curl -s -X POST $API_URL/api/send-email \
  -H "Content-Type: application/json" \
  -d "{
    \"to\": \"$TO_EMAIL\",
    \"subject\": \"测试邮件 - $(date '+%Y-%m-%d %H:%M:%S')\",
    \"text\": \"这是一封来自CentOS服务器的测试邮件。\n\n发送时间：$(date '+%Y-%m-%d %H:%M:%S')\"
  }" | python3 -m json.tool
echo ""
echo ""

# 3. 测试发送HTML邮件
echo "3. 测试发送HTML格式邮件..."
curl -s -X POST $API_URL/api/send-email \
  -H "Content-Type: application/json" \
  -d "{
    \"to\": \"$TO_EMAIL\",
    \"subject\": \"测试邮件 - HTML格式\",
    \"html\": \"<h2>测试邮件</h2><p>这是一封<strong>HTML格式</strong>的测试邮件。</p><p>发送时间：$(date '+%Y-%m-%d %H:%M:%S')</p>\"
  }" | python3 -m json.tool
echo ""
echo ""

echo "=========================================="
echo "测试完成！"
echo "=========================================="
EOF

# 添加执行权限
chmod +x test_email.sh

# 运行测试（记得先修改TO_EMAIL变量）
./test_email.sh
```

## 五、防火墙配置

如果从外部访问，需要开放端口：

```bash
# CentOS 7 使用 firewalld
firewall-cmd --permanent --add-port=12889/tcp
firewall-cmd --reload

# 或者 CentOS 6 使用 iptables
iptables -A INPUT -p tcp --dport 12889 -j ACCEPT
service iptables save
```

## 六、常见问题排查

### 1. 服务无法启动

```bash
# 检查端口是否被占用
netstat -tlnp | grep 12889
# 或
ss -tlnp | grep 12889

# 检查Node.js版本
node -v
# 需要 Node.js 12+ 版本

# 检查依赖是否安装
npm list
```

### 2. 邮件发送失败

```bash
# 查看服务日志
tail -f email-service.log

# 检查.env配置
cat .env

# 测试SMTP连接（可以临时添加测试代码）
```

### 3. curl命令不存在

```bash
# CentOS安装curl
yum install -y curl
# 或
dnf install -y curl
```

## 七、快速测试命令（一行命令）

```bash
# 快速测试发送邮件（记得修改邮箱地址）
curl -X POST http://localhost:12889/api/send-email \
  -H "Content-Type: application/json" \
  -d '{"to":"your_email@example.com","subject":"快速测试","text":"这是一封测试邮件"}'
```

